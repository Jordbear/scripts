#!/bin/bash
directory=$(which jbscripts)_dir/
command=$1
shift

for i in $@; do
  case $i in
    -t|--trim)
    trim="true"
    adapters=$2
    shift
    shift
    ;;
    -i|--index)
    ref_index=$2
    shift
    shift
    ;;
    -r|--reference)
    ref=$2
    shift
    shift
    ;;
    -a|--annotation)
    annotation=$2
    shift
    shift
    ;;
    -h|--help)
    cat "${directory}help.md"
    shift
    ;;
  esac
done



function wgs {
  missing=0
  invalid=0

  if [[ $trim == "true" ]] && [[ -z ${adapters} ]]; then
    missing+=1
    echo "Missing argument: Adapters"
  elif [[ $trim == "true" ]] && [[ ! -f "${TRIMMOMATIC%%trimmomatic-0.39.jar}adapters/${adapters}" ]]; then
    invalid+=1
    echo "File does not exist: ${TRIMMOMATIC%%trimmomatic-0.39.jar}adapters/${adapters}"
  fi

  if [[ -z $ref_index ]]; then
    missing+=1
    echo "Missing argument: Reference index"
  elif [[ ! -f "${ref_index}.1.bt2" ]]; then
    invalid+=1
    echo "File does not exist: ${ref_index}.1.bt2"
  fi

  if [[ -z $ref ]]; then
    missing+=1
    echo "Missing argument: Reference file"
  elif [[ ! -f $ref ]]; then
    invalid+=1
    echo "File does not exist: $ref"
  fi


  if [[ $missing -eq 0 ]] && [[ $invalid -eq 0 ]]; then
    echo "Processing files as WGS data..."
    ${directory}wgs_process_plot.sh ${trim:-"empty"} ${adapters:-"empty"} $ref_index $ref
  fi
}



function tas {
  missing=0
  invalid=0

  if [[ $trim == "true" ]] && [[ -z ${adapters} ]]; then
    missing+=1
    echo "Missing argument: Adapters"
  elif [[ $trim == "true" ]] && [[ ! -f "${TRIMMOMATIC%%trimmomatic-0.39.jar}adapters/${adapters}" ]]; then
    invalid+=1
    echo "File does not exist: ${TRIMMOMATIC%%trimmomatic-0.39.jar}adapters/${adapters}"
  fi

  if [[ -z $ref_index ]]; then
    missing+=1
    echo "Missing argument: Reference index"
  elif [[ ! -f "${ref_index}.1.bt2" ]]; then
    invalid+=1
    echo "File does not exist: ${ref_index}.1.bt2"
  fi

  if [[ -z $ref ]]; then
    missing+=1
    echo "Missing argument: Reference file"
  elif [[ ! -f $ref ]]; then
    invalid+=1
    echo "File does not exist: $ref"
  fi

  if [[ -z $annotation ]]; then
    missing+=1
    echo "Missing argument: Target annotation"
  elif [[ ! -f $annotation ]]; then
    invalid+=1
    echo "File does not exist: $annotation"
  fi


  if [[ $missing -eq 0 ]] && [[ $invalid -eq 0 ]]; then
    echo "Processing files as TAS data..."
    ${directory}tas_process_plot.sh ${trim:-"empty"} ${adapters:-"empty"} $ref_index $ref $annotation
  fi
}



if [[ -z $command ]]; then
  echo "No command given"
  echo "Valid commands: wgs, tas, rna-seq, ssrna-seq"
elif [[ $command == "wgs" ]]; then
  wgs
elif [[ $command == "tas" ]]; then
  tas
elif [[ $command == "rna-seq" ]]; then
  echo "Coming soon"
elif [[ $command == "ssrna-seq" ]]; then
  echo "Maybe some day"
elif [[ $command == "-h" ]] || [[ $command == "--help" ]]; then
  cat "${directory}help.md"
else
  echo "Invalid command: $command"
  echo "Valid commands: wgs, tas, rna-seq, ssrna-seq"
fi
